<!-- templates/video_conferencing/video_room.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ video_class.title }} - Live Class - Kids DIY{% endblock %}

{% block extra_css %}
    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .chat-container {
            height: 60vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0.5rem;
        }

        .user-message {
            background-color: #e9ecef;
            margin-right: 20%;
        }

        .current-user-message {
            background-color: #cfe2ff;
            margin-left: 20%;
        }

        .ai-message {
            background-color: #d1e7dd;
            margin-right: 20%;
            border-left: 4px solid #198754;
        }

        .chat-input {
            margin-top: 15px;
        }

        .controls-container {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 0.25rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ video_class.title }}</h4>
            <div>
                <span class="badge bg-success me-2">Live</span>
                {% if video_class.teacher == user %}
                    <form method="post" action="{% url 'end_video_class' video_class.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fas fa-power-off"></i> End Class
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Video Section -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="video-container">
                                <div id="video-grid" class="w-100 h-100 bg-dark">
                                    <!-- Video elements will be added here by JavaScript -->
                                </div>
                            </div>

                            <div class="controls-container mt-3 text-center">
                                <button id="toggle-video" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button id="toggle-audio" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button id="share-screen" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-desktop"></i>
                                </button>
                                <button id="raise-hand" class="btn btn-outline-warning">
                                    <i class="fas fa-hand-paper"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Class Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Teacher:</strong>
                                            <a href="{% url 'profile' video_class.teacher.username %}">
                                                {{ video_class.teacher.username }}
                                            </a>
                                        </p>
                                        <p><strong>Date & Time:</strong> {{ video_class.scheduled_time|date:"F d, Y - H:i" }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Duration:</strong> {{ video_class.duration }} minutes</p>
                                        <p><strong>Room ID:</strong> {{ video_class.room_id }}</p>
                                    </div>
                                </div>
                                {% if video_class.description %}
                                    <hr>
                                    <p><strong>Description:</strong></p>
                                    <p>{{ video_class.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Live Chat</h5>
                        </div>
                        <div class="card-body p-2">
                            <div class="chat-container">
                                <div id="chat-messages" class="chat-messages">
                                    <div class="text-center text-muted mb-3">
                                        <small>Chat started. Use @ai to ask the AI assistant a question.</small>
                                    </div>
                                    <!-- Chat messages will be added here by JavaScript -->
                                </div>

                                <div class="chat-input">
                                    <form id="chat-form" method="post" action="{% url 'chat_message' video_class.id %}">
                                        {% csrf_token %}
                                        <div class="input-group">
                                            {{ chat_form.content }}
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        $(document).ready(function() {
            // WebSocket setup
            const roomName = "{{ video_class.id }}";
            const userId = "{{ user.id }}";
            const userName = "{{ user.username }}";

            const chatSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/class/' + roomName + '/'
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                addChatMessage(data.user, data.message, data.message_type, data.timestamp);
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            // Chat functionality
            function addChatMessage(username, message, messageType, timestamp) {
                const messageContainer = document.createElement('div');

                if (messageType === 'ai') {
                    messageContainer.className = 'chat-message ai-message';
                } else if (username === userName) {
                    messageContainer.className = 'chat-message current-user-message';
                } else {
                    messageContainer.className = 'chat-message user-message';
                }

                messageContainer.innerHTML = `
                <div>
                    <strong>${username}</strong>
                    <span class="float-end text-muted small">${timestamp}</span>
                </div>
                <div>${message}</div>
            `;

                document.querySelector('#chat-messages').appendChild(messageContainer);

                // Scroll to bottom
                const chatMessages = document.querySelector('#chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Handle chat form submission
            $('#chat-form').submit(function(e) {
                e.preventDefault();

                const messageInputDom = document.querySelector('#id_content');
                const message = messageInputDom.value;

                if (message.trim() === '') return;

                chatSocket.send(JSON.stringify({
                    'message': message,
                    'user_id': userId
                }));

                messageInputDom.value = '';

                // Also send via AJAX to save in the database
                $.ajax({
                    url: "{% url 'chat_message' video_class.id %}",
                    type: 'POST',
                    data: {
                        'content': message,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        // Message will be added by the WebSocket connection
                    }
                });
            });

            // Fetch existing chat messages when page loads
            function loadExistingMessages() {
                $.ajax({
                    url: "{% url 'get_chat_messages' video_class.id %}",
                    type: 'GET',
                    success: function(data) {
                        data.messages.forEach(function(msg) {
                            addChatMessage(msg.user, msg.content, msg.message_type, msg.timestamp);
                        });

                        // Scroll to bottom
                        const chatMessages = document.querySelector('#chat-messages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            }

            loadExistingMessages();

            // Video conferencing functionality with PeerJS
            const videoGrid = document.getElementById('video-grid');
            const myPeer = new Peer(undefined, {
                host: '/',
                port: '3001' // You'd need to set up a PeerJS server
            });

            const myVideo = document.createElement('video');
            myVideo.muted = true; // Mute our own video so we don't hear ourselves

            const peers = {};
            let myStream = null;

            // Get user's audio and video stream
            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then(stream => {
                myStream = stream;
                addVideoStream(myVideo, stream);

                // Answer call from other users
                myPeer.on('call', call => {
                    call.answer(stream);

                    const video = document.createElement('video');
                    call.on('stream', userVideoStream => {
                        addVideoStream(video, userVideoStream);
                    });

                    call.on('close', () => {
                        video.remove();
                    });

                    peers[call.peer] = call;
                });

                // Notify server that we've joined
                chatSocket.send(JSON.stringify({
                    'message': userName + ' has joined the class.',
                    'user_id': 'system'
                }));
            });

            // When a new user connects
            myPeer.on('open', id => {
                // In a complete implementation, you'd broadcast this to other users
                console.log('My peer ID is: ' + id);
            });

            // Function to add a video stream to the grid
            function addVideoStream(video, stream) {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                });
                video.classList.add('w-100', 'h-100');
                videoGrid.append(video);
            }

            // UI Controls
            $('#toggle-video').click(function() {
                const videoTrack = myStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    $(this).toggleClass('btn-outline-primary btn-danger');

                    if (videoTrack.enabled) {
                        $(this).html('<i class="fas fa-video"></i>');
                    } else {
                        $(this).html('<i class="fas fa-video-slash"></i>');
                    }
                }
            });

            $('#toggle-audio').click(function() {
                const audioTrack = myStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    $(this).toggleClass('btn-outline-primary btn-danger');

                    if (audioTrack.enabled) {
                        $(this).html('<i class="fas fa-microphone"></i>');
                    } else {
                        $(this).html('<i class="fas fa-microphone-slash"></i>');
                    }
                }
            });

            $('#share-screen').click(function() {
                navigator.mediaDevices.getDisplayMedia({
                    video: true
                }).then(stream => {
                    // Replace video track with screen track
                    const videoTrack = myStream.getVideoTracks()[0];
                    const screenTrack = stream.getVideoTracks()[0];

                    if (videoTrack && screenTrack) {
                        // Replace in all peer connections
                        for (let peerId in peers) {
                            const sender = peers[peerId].peerConnection.getSenders().find(s => s.track.kind === videoTrack.kind);
                            if (sender) {
                                sender.replaceTrack(screenTrack);
                            }
                        }

                        // Replace in local video
                        const senders = myPeer._connections.map(conn => conn.peerConnection.getSenders()).flat();
                        senders.forEach(sender => {
                            if (sender.track.kind === 'video') {
                                sender.replaceTrack(screenTrack);
                            }
                        });

                        // When screen sharing ends
                        screenTrack.onended = () => {
                            // Replace screen track with video track
                            for (let peerId in peers) {
                                const sender = peers[peerId].peerConnection.getSenders().find(s => s.track.kind === screenTrack.kind);
                                if (sender) {
                                    sender.replaceTrack(videoTrack);
                                }
                            }

                            // Replace in local video
                            const senders = myPeer._connections.map(conn => conn.peerConnection.getSenders()).flat();
                            senders.forEach(sender => {
                                if (sender.track.kind === 'video') {
                                    sender.replaceTrack(videoTrack);
                                }
                            });

                            $(this).removeClass('btn-danger').addClass('btn-outline-primary');
                        };

                        $(this).removeClass('btn-outline-primary').addClass('btn-danger');
                    }
                }).catch(err => {
                    console.error('Error sharing screen:', err);
                });
            });

            $('#raise-hand').click(function() {
                $(this).toggleClass('btn-outline-warning btn-warning');

                if ($(this).hasClass('btn-warning')) {
                    chatSocket.send(JSON.stringify({
                        'message': userName + ' raised their hand.',
                        'user_id': 'system'
                    }));
                } else {
                    chatSocket.send(JSON.stringify({
                        'message': userName + ' lowered their hand.',
                        'user_id': 'system'
                    }));
                }
            });
        });
    </script>
{% endblock %}